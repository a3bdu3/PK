<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Vancomycin VLBW (A priori) — AUC + Probabilistic Trough</title>
  <style>
    :root { --bg:#f3f4f6; --card:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; }
    body { margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width: 1180px; margin: 24px auto; padding: 0 16px; }
    .topbar{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom: 10px; }
    h1 { margin:0; font-size: 18px; }
    .nav a{
      display:inline-block; padding:8px 10px; border-radius: 10px;
      border:1px solid var(--border); background:#fff; color:#111827; text-decoration:none; font-size: 13px;
      margin-left:6px;
    }
    .nav a:hover{ border-color:#9ca3af; }

    .card { background:var(--card); border:1px solid var(--border); border-radius: 16px; padding: 14px; box-shadow: 0 10px 18px rgba(0,0,0,.06); }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .field { display:flex; flex-direction:column; gap:6px; margin-bottom: 10px; }
    label { font-size:12px; color: var(--muted); }
    input, select { padding:10px; border:1px solid var(--border); border-radius: 10px; font-size: 14px; }
    button{
      padding:10px 12px; border-radius: 12px; border:1px solid #111827; background:#111827; color:#fff;
      cursor:pointer; font-size: 14px;
    }
    button.secondary{ background:#fff; color:#111827; border-color: var(--border); }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top: 6px; }
    .mini { color: var(--muted); font-size: 12px; line-height: 1.5; }
    .pill { display:inline-block; font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; color: var(--muted); background:#fff; }

    .out{ margin-top:10px; padding:10px; border:1px dashed var(--border); border-radius:12px; background:#f9fafb; }
    .err{ color:#b91c1c; font-size:12px; margin-top:10px; white-space: pre-wrap; }

    canvas { width:100%; height:360px; display:block; background:#fff; border:1px solid var(--border); border-radius:12px; margin-top: 10px; }

    table{ width:100%; border-collapse:collapse; margin-top:10px; font-size: 13px; }
    th, td{ border-bottom:1px solid var(--border); padding:8px; text-align:left; }
    th{ color: var(--muted); font-weight: 700; font-size: 12px; }
    .ok{ color:#065f46; }
    .bad{ color:#b91c1c; }
    code{ font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px; }

    .divider { height:1px; background: var(--border); margin: 12px 0; }

    /* Hover tooltip for plot */
    .tooltip {
      position: fixed;
      pointer-events: none;
      background: rgba(17, 24, 39, 0.92);
      color: #fff;
      padding: 6px 8px;
      border-radius: 10px;
      font-size: 12px;
      line-height: 1.2;
      display: none;
      z-index: 9999;
      transform: translate(10px, 10px);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>Vancomycin VLBW — A priori dosing (AUC24 + Probabilistic trough)</h1>
      <div class="nav">
        <a href="index.html">Home</a>
        <a href="calculators.html">Calculators</a>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Inputs -->
      <div class="card">
        <div class="row">
          <span class="pill">Inputs</span>
          <span class="mini">
            Infusion duration fixed at <b>2 hours</b>. Daily dose targets <b>AUC0–24 = 400</b> (typical).
            Choose first interval where <b>P(trough&gt;20) &lt; 10%</b>.
          </span>
        </div>

        <div class="grid" style="grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
          <div class="field">
            <label>Weight (kg)</label>
            <input id="wt" type="number" step="any" value="1.0" min="0.1"/>
          </div>
          <div class="field">
            <label>GA (weeks)</label>
            <input id="ga" type="number" step="any" value="28" min="20"/>
          </div>
          <div class="field">
            <label>PNA (days)</label>
            <input id="pna" type="number" step="any" value="7" min="0"/>
          </div>
          <div class="field">
            <label>SCr (mg/dL)</label>
            <input id="scr" type="number" step="any" value="0.6" min="0.1"/>
          </div>
          <div class="field">
            <label>Monte Carlo samples (n)</label>
            <input id="nmc" type="number" step="100" value="3000" min="500"/>
          </div>
          <div class="field">
            <label>Units label</label>
            <select id="unit">
              <option value="mg/L">mg/L</option>
              <option value="µg/mL">µg/mL</option>
            </select>
          </div>
        </div>

        <div class="row">
          <button id="run">Run (recommend)</button>
          <button class="secondary" id="reset">Reset</button>
        </div>

        <div class="divider"></div>

        <div class="row">
          <span class="pill">Manual dose</span>
          <span class="mini">Simulates <b>5 doses</b> (5 administrations) and plots concentration over that window.</span>
        </div>

        <div class="grid" style="grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
          <div class="field">
            <label>Manual interval</label>
            <select id="manualTau">
              <option value="6">q6h</option>
              <option value="8">q8h</option>
              <option value="12" selected>q12h</option>
              <option value="18">q18h</option>
              <option value="24">q24h</option>
            </select>
          </div>
          <div class="field">
            <label>Manual dose per admin (mg)</label>
            <input id="manualDose" type="number" step="any" value="15" min="0.1"/>
          </div>
        </div>

        <div class="row">
          <button class="secondary" id="simulateManual">Simulate manual (5 doses)</button>
        </div>

        <div class="mini" style="margin-top:10px;">
          Model:
          <div><code>PMA (weeks) = GA + PNA/7</code></div>
          <div><code>V = 0.81*(WT/0.93)</code></div>
          <div><code>CL = 0.09*(WT/0.93)^0.75*(0.6/SCr)^0.48 * PMA^4.42/(PMA^4.42 + 26.3^4.42)</code></div>
          <div><code>Daily dose (mg/24h) = 400 × CLtyp</code></div>
          <div><code>Pick first τ in [6,8,12,18,24] with P(trough&gt;20)&lt;10%</code></div>
        </div>

        <div class="err" id="err"></div>
      </div>

      <!-- RIGHT: Results + Plot -->
      <div class="card">
        <div class="row">
          <span class="pill">Results</span>
          <span class="mini">Probability uses log-normal IIV: ωCL=0.28, ωV=0.24. Trough computed at steady-state (just before next infusion).</span>
        </div>

        <div id="summary" class="out" style="display:none;"></div>

        <div id="tableWrap" style="display:none;">
          <table>
            <thead>
              <tr>
                <th>Interval</th>
                <th>Dose per admin</th>
                <th>P(trough &gt; 20)</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="probTable"></tbody>
          </table>
        </div>

        <canvas id="cv"></canvas>
        <div id="plotTip" class="tooltip"></div>

        <div class="mini">
          Hover on the curve to see concentration at that time.
          Plot shows <b>typical</b> profile (CLtyp/Vtyp). Dashed line = 20.
        </div>
      </div>
    </div>
  </div>

<script>
function fmt(x, d=4){
  if (!Number.isFinite(x)) return "NA";
  const ax = Math.abs(x);
  if (ax !== 0 && (ax >= 1e6 || ax < 1e-4)) return x.toExponential(4);
  return x.toFixed(d);
}

const TINF = 2.0;
const TARGET_AUC24 = 400.0;
const TROUGH_LIMIT = 20.0;
const MAX_PROB = 0.10;
const TAU_ORDER = [6, 8, 12, 18, 24];

const OMEGA_CL = 0.28;
const OMEGA_V  = 0.24;

function covariatePrior(wt, gaWeeks, pnaDays, scr){
  const pnaWeeks = pnaDays / 7.0;
  const pma = gaWeeks + pnaWeeks;

  const wtStd = 0.93;
  const V = 0.81 * (wt / wtStd);

  const hill = 4.42;
  const tm50 = 26.3;
  const matur = Math.pow(pma, hill) / (Math.pow(pma, hill) + Math.pow(tm50, hill));

  const CL = 0.09 *
    Math.pow(wt / wtStd, 0.75) *
    Math.pow(0.6 / scr, 0.48) *
    matur;

  return { CLtyp: CL, Vtyp: V, PNAweeks: pnaWeeks, PMA: pma };
}

function randn(){
  let u = 0, v = 0;
  while (u === 0) u = Math.random();
  while (v === 0) v = Math.random();
  return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
}

function troughSSInfusion(doseMg, tau, cl, v){
  const ke = cl / v;
  const A = Math.exp(-ke * TINF);
  const B = Math.exp(-ke * (tau - TINF));
  const expTau = A * B;

  const R0 = doseMg / TINF;
  const denom = (1.0 - expTau);
  if (denom <= 1e-12) return Infinity;

  return B * (R0 / cl) * (1.0 - A) / denom;
}

function auc24FromRegimen(doseEachMg, tau, cl){
  const dailyDose = doseEachMg * (24.0 / tau);
  return dailyDose / cl;
}

function concAtTime(t, events, cl, v){
  const ke = cl / v;
  let c = 0;

  for (const ev of events){
    if (t < ev.t0) continue;
    const dt = t - ev.t0;

    const R0 = ev.dose / TINF;
    if (dt <= TINF){
      c += (R0 / cl) * (1 - Math.exp(-ke * dt));
    } else {
      const cEnd = (R0 / cl) * (1 - Math.exp(-ke * TINF));
      c += cEnd * Math.exp(-ke * (dt - TINF));
    }
  }
  return Math.max(c, 1e-12);
}

function buildEvents(tau, doseEach, nDoses){
  const events = [];
  for (let k=0; k<nDoses; k++){
    events.push({ t0: k * tau, dose: doseEach });
  }
  return events;
}

function runSelection(wt, ga, pna, scr, nmc){
  const cov = covariatePrior(wt, ga, pna, scr);
  const CLtyp = cov.CLtyp;
  const Vtyp = cov.Vtyp;

  const dailyDose = TARGET_AUC24 * CLtyp;

  const rows = [];
  let selected = null;

  for (const tau of TAU_ORDER){
    const doseEach = dailyDose * (tau / 24.0);

    let count = 0;
    for (let i=0; i<nmc; i++){
      const cl = Math.exp(Math.log(CLtyp) + OMEGA_CL * randn());
      const v  = Math.exp(Math.log(Vtyp)  + OMEGA_V  * randn());
      const tr = troughSSInfusion(doseEach, tau, cl, v);
      if (tr > TROUGH_LIMIT) count++;
    }
    const p = count / nmc;

    const ok = (p < MAX_PROB);
    rows.push({ tau, doseEach, p, ok });

    if (!selected && ok){
      selected = { tau, doseEach, p };
      break;
    }
  }

  return { cov, dailyDose, rows, selected, okFinal: Boolean(selected) };
}

/* Plotting + hover */
let PLOT_STATE = null;

function drawPlot(canvas, series, xLabel, yLabel, hlineY=null){
  const ctx = canvas.getContext("2d");
  const dpr = window.devicePixelRatio || 1;

  const cssW = canvas.clientWidth;
  const cssH = canvas.clientHeight;
  canvas.width = Math.round(cssW * dpr);
  canvas.height = Math.round(cssH * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);

  ctx.clearRect(0,0,cssW,cssH);

  const padL = 92, padR = 18, padT = 14, padB = 44;
  const W = cssW - padL - padR;
  const H = cssH - padT - padB;

  const xs = series.map(p=>p.x);
  const ys = series.map(p=>p.y);

  let xmin = Math.min(...xs), xmax = Math.max(...xs);
  let ymin = 0;
  let ymax = Math.max(...ys, (hlineY ?? 0));
  if (!Number.isFinite(ymax) || ymax <= 0) ymax = 1;
  if (xmax === xmin) xmax = xmin + 1;
  ymax *= 1.06;

  const xTo = x => padL + ((x-xmin)/(xmax-xmin))*W;
  const yTo = y => padT + H - ((y-ymin)/(ymax-ymin))*H;

  PLOT_STATE = {
    series,
    padL, padT, W, H,
    xmin, xmax, ymin, ymax,
    xFrom: px => xmin + ((px - padL)/W) * (xmax - xmin),
    inPlot: (px, py) => (px>=padL && px<=padL+W && py>=padT && py<=padT+H)
  };

  ctx.strokeStyle = "#111827";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padL, padT);
  ctx.lineTo(padL, padT+H);
  ctx.lineTo(padL+W, padT+H);
  ctx.stroke();

  ctx.font = "12px Arial";
  const xTicks=6, yTicks=5;

  for (let i=0;i<=xTicks;i++){
    const t = i/xTicks;
    const x = padL + t*W;
    const xv = xmin + t*(xmax-xmin);
    ctx.strokeStyle="#e5e7eb";
    ctx.beginPath(); ctx.moveTo(x,padT); ctx.lineTo(x,padT+H); ctx.stroke();
    ctx.fillStyle="#6b7280";
    ctx.textAlign="center"; ctx.textBaseline="top";
    ctx.fillText(fmt(xv,0), x, padT+H+8);
  }
  for (let i=0;i<=yTicks;i++){
    const t = i/yTicks;
    const y = padT+H - t*H;
    const yv = ymin + t*(ymax-ymin);
    ctx.strokeStyle="#e5e7eb";
    ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(padL+W,y); ctx.stroke();
    ctx.fillStyle="#6b7280";
    ctx.textAlign="right"; ctx.textBaseline="middle";
    ctx.fillText(fmt(yv,1), padL-10, y);
  }

  ctx.fillStyle="#111827";
  ctx.textAlign="center"; ctx.textBaseline="alphabetic";
  ctx.fillText(xLabel, padL+W/2, padT+H+36);

  ctx.save();
  ctx.translate(20, padT+H/2);
  ctx.rotate(-Math.PI/2);
  ctx.textAlign="center"; ctx.textBaseline="alphabetic";
  ctx.fillText(yLabel, 0, 0);
  ctx.restore();

  if (hlineY !== null){
    const y = yTo(hlineY);
    ctx.setLineDash([6,4]);
    ctx.strokeStyle="#111827";
    ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(padL+W,y); ctx.stroke();
    ctx.setLineDash([]);
  }

  ctx.strokeStyle="#111827";
  ctx.lineWidth=2;
  ctx.beginPath();
  series.forEach((p,idx)=>{
    const xp = xTo(p.x), yp = yTo(p.y);
    if (idx===0) ctx.moveTo(xp,yp); else ctx.lineTo(xp,yp);
  });
  ctx.stroke();
}

const cv = document.getElementById("cv");
const tip = document.getElementById("plotTip");

function nearestPointByX(series, x){
  let lo = 0, hi = series.length - 1;
  while (hi - lo > 1){
    const mid = (lo + hi) >> 1;
    if (series[mid].x < x) lo = mid; else hi = mid;
  }
  return (Math.abs(series[lo].x - x) <= Math.abs(series[hi].x - x)) ? series[lo] : series[hi];
}

cv.addEventListener("mousemove", (ev) => {
  if (!PLOT_STATE) return;

  const rect = cv.getBoundingClientRect();
  const px = ev.clientX - rect.left;
  const py = ev.clientY - rect.top;

  if (!PLOT_STATE.inPlot(px, py)){
    tip.style.display = "none";
    return;
  }

  const unit = document.getElementById("unit").value;
  const xVal = PLOT_STATE.xFrom(px);
  const p = nearestPointByX(PLOT_STATE.series, xVal);

  tip.style.left = ev.clientX + "px";
  tip.style.top  = ev.clientY + "px";
  tip.style.display = "block";
  tip.innerHTML = `t: <b>${fmt(p.x,2)} h</b><br/>C: <b>${fmt(p.y,2)} ${unit}</b>`;
});

cv.addEventListener("mouseleave", () => {
  tip.style.display = "none";
});

/* UI */
const errEl = document.getElementById("err");
const summaryEl = document.getElementById("summary");
const tableWrap = document.getElementById("tableWrap");
const probTable = document.getElementById("probTable");

function validateInputs(){
  const wt = Number(document.getElementById("wt").value);
  const ga = Number(document.getElementById("ga").value);
  const pna = Number(document.getElementById("pna").value);
  const scr = Number(document.getElementById("scr").value);
  const nmc = Math.floor(Number(document.getElementById("nmc").value));
  if (!(wt>0 && ga>0 && pna>=0 && scr>0 && nmc>=500)){
    throw new Error("Please enter valid inputs. Monte Carlo n must be ≥ 500.");
  }
  return { wt, ga, pna, scr, nmc };
}

function resetUI(){
  errEl.textContent = "";
  summaryEl.style.display = "none";
  tableWrap.style.display = "none";
  probTable.innerHTML = "";
  drawPlot(cv, [{x:0,y:0},{x:1,y:0}], "Time (h)", "Concentration", 20);
}
resetUI();
document.getElementById("reset").onclick = resetUI;

/* Recommend */
document.getElementById("run").onclick = ()=>{
  errEl.textContent = "";
  try{
    const { wt, ga, pna, scr, nmc } = validateInputs();
    const unit = document.getElementById("unit").value;

    const out = runSelection(wt, ga, pna, scr, nmc);
    const { cov, dailyDose, rows, selected, okFinal } = out;

    probTable.innerHTML = "";
    rows.forEach(r=>{
      const status = r.ok ? `<span class="ok"><b>OK</b></span>` : `<span class="bad"><b>Fail</b></span>`;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>q${r.tau}h</td>
        <td>${fmt(r.doseEach,2)} mg</td>
        <td>${fmt(100*r.p,1)}%</td>
        <td>${status}</td>
      `;
      probTable.appendChild(tr);
    });
    tableWrap.style.display = "block";

    const dailyDosePerKg = dailyDose / wt;

    let html = `
      <b>Covariates</b><br/>
      PNA (weeks): ${fmt(cov.PNAweeks,3)}<br/>
      PMA (weeks): ${fmt(cov.PMA,3)}<br/>
      CLtyp (L/h): ${fmt(cov.CLtyp,6)}<br/>
      Vtyp (L): ${fmt(cov.Vtyp,6)}<br/>
      Infusion: <b>2 hours</b><br/><br/>

      <b>Step 1 — Daily dose for AUC0–24=400 (typical)</b><br/>
      Daily dose: ${fmt(dailyDose,2)} mg/24h (${fmt(dailyDosePerKg,2)} mg/kg/day)<br/><br/>
    `;

    let tauPlot = 24;
    let doseEachPlot = dailyDose * (tauPlot/24);

    if (okFinal){
      const doseEachPerKg = selected.doseEach / wt;
      const troughTyp = troughSSInfusion(selected.doseEach, selected.tau, cov.CLtyp, cov.Vtyp);
      const aucTyp = auc24FromRegimen(selected.doseEach, selected.tau, cov.CLtyp);

      html += `
        <b>Step 2 — Frequency selection</b><br/>
        Selected: <span class="ok"><b>q${selected.tau}h</b></span><br/>
        Dose per administration: ${fmt(selected.doseEach,2)} mg (${fmt(doseEachPerKg,2)} mg/kg)<br/>
        Estimated P(trough &gt; 20): <b>${fmt(100*selected.p,1)}%</b> (must be &lt; 10%)<br/><br/>

        <b>Predicted (typical) for recommended regimen</b><br/>
        Typical trough (SS): <b>${fmt(troughTyp,2)} ${unit}</b><br/>
        Typical AUC0–24: <b>${fmt(aucTyp,1)} mg·h/L</b><br/>
      `;

      tauPlot = selected.tau;
      doseEachPlot = selected.doseEach;
    } else {
      html += `
        <b>Step 2 — Frequency selection</b><br/>
        <span class="bad"><b>NA</b></span> — Even q24 gives P(trough &gt; 20) ≥ 10%.<br/>
        Interpretation: patient has renal failure / model not suitable.<br/><br/>
      `;
      const troughTyp = troughSSInfusion(doseEachPlot, tauPlot, cov.CLtyp, cov.Vtyp);
      const aucTyp = auc24FromRegimen(doseEachPlot, tauPlot, cov.CLtyp);

      html += `
        <b>Predicted (typical) preview at q24</b><br/>
        Typical trough (SS): <b>${fmt(troughTyp,2)} ${unit}</b><br/>
        Typical AUC0–24: <b>${fmt(aucTyp,1)} mg·h/L</b><br/>
      `;
    }

    summaryEl.innerHTML = html;
    summaryEl.style.display = "block";

    // Plot recommended over 72h with repeated doses (for visualization)
    const nDoses = Math.max(6, Math.ceil(72 / tauPlot) + 1);
    const events = buildEvents(tauPlot, doseEachPlot, nDoses);

    const tEnd = (nDoses - 1) * tauPlot + tauPlot; // one more interval after last start
    const dt = 0.05;
    const series = [];
    for (let t=0; t<=tEnd+1e-9; t+=dt){
      series.push({ x:t, y: concAtTime(t, events, cov.CLtyp, cov.Vtyp) });
    }
    drawPlot(cv, series, "Time (h)", `Concentration (${unit})`, 20);

  } catch(e){
    errEl.textContent = String(e);
  }
};

/* Manual (5 doses) */
document.getElementById("simulateManual").onclick = ()=>{
  errEl.textContent = "";
  try{
    const { wt, ga, pna, scr } = validateInputs();
    const unit = document.getElementById("unit").value;
    const cov = covariatePrior(wt, ga, pna, scr);

    const tau = Number(document.getElementById("manualTau").value);
    const doseEach = Number(document.getElementById("manualDose").value);
    if (!(doseEach > 0)) throw new Error("Manual dose must be > 0 mg.");

    const troughTyp = troughSSInfusion(doseEach, tau, cov.CLtyp, cov.Vtyp);
    const aucTyp = auc24FromRegimen(doseEach, tau, cov.CLtyp);
    const dailyDose = doseEach * (24.0 / tau);
    const dailyDosePerKg = dailyDose / wt;

    const current = summaryEl.style.display === "none" ? "" : summaryEl.innerHTML;
    const manualHtml = `
      <div class="divider"></div>
      <b>Manual regimen (typical predictions)</b><br/>
      Manual: ${fmt(doseEach,2)} mg q${tau}h (2h infusion)<br/>
      Daily dose: ${fmt(dailyDose,2)} mg/24h (${fmt(dailyDosePerKg,2)} mg/kg/day)<br/>
      Typical trough (SS): <b>${fmt(troughTyp,2)} ${unit}</b><br/>
      Typical AUC0–24: <b>${fmt(aucTyp,1)} mg·h/L</b><br/>
      Plot window: <b>5 doses</b> (from dose 1 to dose 5)
    `;
    summaryEl.innerHTML = (current || "") + manualHtml;
    summaryEl.style.display = "block";

    // Simulate EXACTLY 5 doses
    const nDoses = 5;
    const events = buildEvents(tau, doseEach, nDoses);

    // plot from 0 to just before dose 6 (i.e., 5 intervals)
    const tEnd = (nDoses) * tau; // includes the washout after 5th start until next scheduled time
    const dt = 0.02;
    const series = [];
    for (let t=0; t<=tEnd+1e-9; t+=dt){
      series.push({ x:t, y: concAtTime(t, events, cov.CLtyp, cov.Vtyp) });
    }
    drawPlot(cv, series, "Time (h)", `Concentration (${unit})`, 20);

  } catch(e){
    errEl.textContent = String(e);
  }
};
</script>
</body>
</html>

